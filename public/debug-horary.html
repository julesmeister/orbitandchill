<!DOCTYPE html>
<html>
<head>
    <title>Horary Database Debug</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .button { padding: 10px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
    </style>
</head>
<body>
    <h1>üîß Horary Database Debug Tool</h1>
    
    <div>
        <button class="button" onclick="checkEnv()">üîç Check Environment Variables</button>
        <button class="button" onclick="testConnection()">üîå Test Database Connection</button>
        <button class="button" onclick="listTables()">üìä List Database Tables</button>
        <button class="button" onclick="createHoraryTable()">üîß Create Horary Table</button>
        <button class="button" onclick="testQuestionCreation()">‚ú® Test Question Creation</button>
        <button class="button" onclick="testRealLocationQuestion()">üìç Test with Real User Location</button>
        <button class="button" onclick="testHoraryCreation()">üß™ Test Horary Creation (Debug)</button>
    </div>
    
    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6;">
        <h3>üîç User Lookup Debug</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
            Debug why user <code>113425479876942125321</code> returns 404 when the user is clearly logged in
        </p>
        <input type="text" id="userIdInput" placeholder="Enter User ID (e.g., 113425479876942125321)" style="width: 300px; padding: 8px; margin-right: 10px;" value="113425479876942125321">
        <button class="button" onclick="debugUserLookup()">üîç Debug User Lookup</button>
        <button class="button" onclick="testLocationAPI()">üìç Test Location API</button>
    </div>
    
    <div id="results"></div>

    <script>
        function addResult(title, data, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        async function checkEnv() {
            try {
                const response = await fetch('/api/debug/env-check');
                const data = await response.json();
                addResult('üîç Environment Variables', data, !response.ok);
            } catch (error) {
                addResult('‚ùå Environment Check Error', { error: error.message }, true);
            }
        }

        async function testConnection() {
            try {
                const response = await fetch('/api/debug/db-connection');
                const data = await response.json();
                addResult('üîå Database Connection Test', data, !response.ok);
            } catch (error) {
                addResult('‚ùå Connection Test Error', { error: error.message }, true);
            }
        }

        async function listTables() {
            try {
                const response = await fetch('/api/debug/list-tables');
                const data = await response.json();
                addResult('üìä Database Tables', data, !response.ok);
            } catch (error) {
                addResult('‚ùå List Tables Error', { error: error.message }, true);
            }
        }

        async function createHoraryTable() {
            try {
                const response = await fetch('/api/debug/create-horary-table', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                addResult('üîß Create Horary Table', data, !response.ok);
            } catch (error) {
                addResult('‚ùå Create Table Error', { error: error.message }, true);
            }
        }

        async function testQuestionCreation() {
            try {
                // Get user's actual location from the Location API first
                const userId = document.getElementById('userIdInput').value;
                let userLocation = null;
                
                if (userId) {
                    try {
                        const locationResponse = await fetch(`/api/users/location?userId=${encodeURIComponent(userId)}`);
                        const locationData = await locationResponse.json();
                        if (locationData.success && locationData.location) {
                            userLocation = locationData.location;
                        }
                    } catch (error) {
                        console.warn('Could not fetch user location for test:', error);
                    }
                }

                // Test payloads with both hardcoded and real location data
                const testPayloads = [
                    {
                        name: 'Old Format (Direct Fields) - Test Data',
                        payload: {
                            question: 'Debug test question - old format location',
                            date: new Date().toISOString(),
                            userId: null,
                            location: 'New York, NY, USA',
                            latitude: 40.7128,
                            longitude: -74.0060,
                            timezone: 'America/New_York',
                            category: 'test'
                        }
                    },
                    {
                        name: 'New Format (customLocation) - Test Data',
                        payload: {
                            question: 'Debug test question - new format location',
                            date: new Date().toISOString(),
                            userId: null,
                            category: 'test',
                            customLocation: {
                                name: 'San Francisco, CA, USA',
                                coordinates: { lat: '37.7749', lon: '-122.4194' }
                            }
                        }
                    }
                ];

                // Add test with user's real location if available
                if (userLocation) {
                    testPayloads.push({
                        name: 'Real User Location (customLocation format)',
                        payload: {
                            question: `Debug test question - using real location: ${userLocation.name}`,
                            date: new Date().toISOString(),
                            userId: userId,
                            category: 'test',
                            customLocation: {
                                name: userLocation.name,
                                coordinates: { 
                                    lat: userLocation.coordinates.lat, 
                                    lon: userLocation.coordinates.lon 
                                }
                            }
                        }
                    });
                }

                for (const test of testPayloads) {
                    const response = await fetch('/api/horary/questions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(test.payload)
                    });
                    const data = await response.json();
                    addResult(`‚ú® Test Question Creation - ${test.name}`, {
                        ...data,
                        requestPayload: test.payload,
                        statusCode: response.status
                    }, !response.ok);
                }
            } catch (error) {
                addResult('‚ùå Question Creation Error', { error: error.message }, true);
            }
        }

        async function testRealLocationQuestion() {
            try {
                const userId = document.getElementById('userIdInput').value;
                if (!userId) {
                    addResult('‚ùå Real Location Test Error', { error: 'Please enter a user ID first' }, true);
                    return;
                }

                // Get user's actual location
                const locationResponse = await fetch(`/api/users/location?userId=${encodeURIComponent(userId)}`);
                const locationData = await locationResponse.json();
                
                if (!locationData.success || !locationData.location) {
                    addResult('‚ùå Real Location Test Error', { 
                        error: 'Could not fetch user location', 
                        locationResponse: locationData 
                    }, true);
                    return;
                }

                const userLocation = locationData.location;

                // Create question with user's real location
                const testPayload = {
                    question: `Real location test - ${new Date().toLocaleString()}`,
                    date: new Date().toISOString(),
                    userId: userId,
                    category: 'test',
                    customLocation: {
                        name: userLocation.name,
                        coordinates: { 
                            lat: userLocation.coordinates.lat, 
                            lon: userLocation.coordinates.lon 
                        }
                    }
                };

                const response = await fetch('/api/horary/questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });
                
                const data = await response.json();
                addResult('üìç Real User Location Test', {
                    ...data,
                    requestPayload: testPayload,
                    statusCode: response.status,
                    userLocationUsed: userLocation
                }, !response.ok);
            } catch (error) {
                addResult('‚ùå Real Location Test Error', { error: error.message }, true);
            }
        }

        async function testHoraryCreation() {
            try {
                const response = await fetch('/api/debug/test-horary-creation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                addResult('üß™ Debug Horary Creation Test', data, !response.ok);
            } catch (error) {
                addResult('‚ùå Debug Creation Test Error', { error: error.message }, true);
            }
        }

        async function debugUserLookup() {
            try {
                const userId = document.getElementById('userIdInput').value;
                if (!userId) {
                    addResult('‚ùå User Lookup Error', { error: 'Please enter a user ID' }, true);
                    return;
                }
                
                const response = await fetch(`/api/debug/user-lookup?userId=${encodeURIComponent(userId)}`);
                const data = await response.json();
                addResult(`üîç User Lookup Debug for: ${userId}`, data, !response.ok);
            } catch (error) {
                addResult('‚ùå User Lookup Error', { error: error.message }, true);
            }
        }

        async function testLocationAPI() {
            try {
                const userId = document.getElementById('userIdInput').value;
                if (!userId) {
                    addResult('‚ùå Location API Test Error', { error: 'Please enter a user ID' }, true);
                    return;
                }
                
                // Test the exact same API call that's failing in the app
                const response = await fetch(`/api/users/location?userId=${encodeURIComponent(userId)}`);
                const data = await response.json();
                
                const result = {
                    statusCode: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    responseData: data,
                    isSuccess: response.ok
                };
                
                addResult(`üìç Location API Test for: ${userId}`, result, !response.ok);
            } catch (error) {
                addResult('‚ùå Location API Test Error', { error: error.message }, true);
            }
        }
    </script>
</body>
</html>